---
title: "SpatialAnalysis"
author: "Maggie O'Shea"
date: "4/12/2022"
output: html_document
---
#Maggie note to self (where left off)
* Merged files but data won't transfer from flood properties to spatial data - waiting to hear from John --> should be easy to map from there 

```{r setup, include=FALSE}
library(tidyverse, quietly = TRUE)
library(lubridate)

#install.packages('sf')
library(sf)
#install.packages('leaflet')
library(leaflet)
#install.packages('mapview')
library(mapview)

raw_flooddata <- read.csv("./Data/Raw_Data/HazardMitigationAssistanceMitigatedProperties.csv", stringsAsFactors = TRUE)

#Removed shapefile from code because it was too big to push up 
#USA_counties <- st_read('./Data/Raw_Data/USA_Counties/USA_Counties.shp')
NC_countyboundaries <- st_read('./Data/Raw_Data/North_Carolina_State_and_County_Boundary_Polygons')

```


##Wrangle by County

#Actual Amount Paid 
```{r}
#All flood properties
NC_clean_hazardprops <- raw_flooddata %>%
  filter(!is.na(actualAmountPaid))%>%
  filter(actualAmountPaid > 0)%>%
  filter(state == "North Carolina")

NC.floodproperties_amountpaid <- NC_clean_hazardprops %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10|202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(county, state)%>%
  summarise(All_propertiesamountpaid = sum(actualAmountPaid))

#Ex situ
NC.buyoutfloodproperties_amountpaid <- NC_clean_hazardprops %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10', type))%>%
  group_by(county, state)%>%
  summarise(Buyouts_propertiesamountpaid = sum(actualAmountPaid))

#In situ
NC.insitufloodproperties_amountpaid <- NC_clean_hazardprops %>%
  filter(grepl('202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(county, state)%>%
  summarise(insituproperties_amountpaid = sum(actualAmountPaid))

in.ex.county <- left_join(NC.buyoutfloodproperties_amountpaid, NC.insitufloodproperties_amountpaid, by = c("county", "state"))

amountpaid.NCall <- left_join(in.ex.county, NC.floodproperties_amountpaid, by = c("county", "state"))

```

#Number of Properties
```{r}
NC.floodproperties_number <- NC_clean_hazardprops %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10|202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(county, state)%>%
  summarise(All_propertiesamountpaid = sum(numberOfProperties))

#Ex situ
NC.buyoutfloodproperties <- NC_clean_hazardprops %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10', type))%>%
  group_by(county, state)%>%
  summarise(Buyouts_propertiesperyear = sum(numberOfProperties))

#In situ
NC.insitufloodproperties <- NC_clean_hazardprops  %>%
  filter(grepl('202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(county, state)%>%
  summarise(insitupropertiesperyear = sum(numberOfProperties))

insitu.props <- left_join(NC.insitufloodproperties, NC.buyoutfloodproperties, by = c("county", "state"))
numberofprops.NC <- left_join(insitu.props, NC.floodproperties_number, by = c("county", "state"))
```

```{r make and wrangle combiined dataset}
alldata.bycountyNC <- left_join(numberofprops.NC, amountpaid.NCall, by = c("county", "state"))

#Turn NAs to zeros because [assumption we are making is..] those counties with no value in column indicates that they did not receive a grant

alldata.bycountyNC[is.na(alldata.bycountyNC)] <- 0  


flood_counties_merge <-  merge(x = NC_countyboundaries,
                           y = alldata.bycountyNC, 
                           by.x = 'County', 
                           by.y = 'county')

#Turn NAs to zeros again for added counties from map 
flood_counties_merge [is.na(flood_counties_merge)] <- 0  

class(flood_counties_merge)
```


```{r}
mapview(flood_counties_merge, zcol='All_propertiesamountpaid')
```

