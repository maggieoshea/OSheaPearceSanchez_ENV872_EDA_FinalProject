---
title: "Temporal and Spatial Trends in Adaptation to Flooding in the United States"
author: "Maggie O'Shea, Garrett Pearce, and Diane Sanchez"
output:
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
  html_document:
    df_print: paged
subtitle: https://github.com/maggieoshea/OSheaPearceSanchez_ENV872_EDA_FinalProject.git
geometry: margin=2.54cm
fontsize: 12pt
mainfont: Times New Roman
---

# Left to do: 
* Figure out a way to get the table names into the table of contents
* Figure out why the figures are knitting in the wrong place
* Set theme so that the axis text aren't bigger than the title text 

\newpage
\tableofcontents 
\newpage
\listoftables 
1 Selected Flooding Adaptation Type Codes..........................7  
2 FEMA Hazard Mitigated Properties Dataset: Summary Statistics  
3 Results from Time Series Analysis of All Adaptation Types      
4 Results from Time Series Analysis of Ex-Situ Adaptation     
5 Results from Time Series Analysis of In-Situ Adaptation 
\newpage
\listoffigures 
\newpage

```{r, include=FALSE, message=FALSE, warning=FALSE}
options(tinytex.verbose = TRUE)
```

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
# Set your working directory
getwd()

# Load your packages
library(tidyverse)
library(lubridate)
#install.packages('sf')
library(sf)
#install.packages('leaflet')
library(leaflet)
#install.packages('mapview')
#install.packages("mdthemes")
library(mdthemes)
library(gt)
library(RColorBrewer)
library(viridis)


# Set your ggplot theme

finalprojecttheme <- theme_light(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
            legend.position = "right",  
            plot.title = element_text(size=11), 
            plot.subtitle = element_text(size=10))
theme_set(finalprojecttheme)

# Load your datasets

## Load primary datasets
inflation_data <- read.csv("./Data/Processed/inflationadjusted.csv")
databyyear <- read.csv("./Data/Processed/alldatabyyear.csv")
NC_flooddata<- read.csv("./Data/Processed/databycounty_forspatial.csv")
NC_countyboundaries <- st_read('./Data/Raw_Data/North_Carolina_State_and_County_Boundary_Polygons')

## Load Data exploration wrangled data
totalprops_pivot <- read.csv('./Data/Processed/totalproperties_explorationgraph')
totals_inflation_pivot <- read.csv( './Data/Processed/totalamountpaidinflation_explorationgraph')


## Load Time Series Results 
ts_propall <- read.csv("./Data/Processed/Time_Series_Results/tsresults_allprops.csv")
ts_paidall <- read.csv("./Data/Processed/Time_Series_Results/tsresults_allpaid.csv")
ts_paidinflationall <- read.csv("./Data/Processed/Time_Series_Results/tsresults_allpaidinflation.csv")
ts_buyoutprops <- read.csv("./Data/Processed/Time_Series_Results/tsresults_buyoutprops.csv")
ts_buyoutpaid <- read.csv("./Data/Processed/Time_Series_Results/tsresults_buyoutamountpaid.csv")
ts_buyoutpaidinflation <- read.csv("./Data/Processed/Time_Series_Results/tsresults_buyoutamountpaidinflation.csv")
ts_insituprops <- read.csv("./Data/Processed/Time_Series_Results/tsresults_insituprops.csv")
ts_insitupaid <- read.csv("./Data/Processed/Time_Series_Results/tsresults_insituamountpaid.csv")
ts_insitupaidinflation <- read.csv("./Data/Processed/Time_Series_Results/tsresults_insituamountpaidinflation.csv")




```

\newpage

# Rationale and Research Questions

Extreme weather events and natural disasters seem to be on the rise worldwide, and climate adaptation is vital to communities at risk. In the U.S., flooding is the most common natural disaster with the cost of flooding in the United States in 2020 estimated at $32.1 billion (IDMC 2019, Lindsey 2022, Wing et al. 2022). These costs, both financial as well as social, are expected to only rise as there is a predicted 24% increase in flooding by 2050 (Wing et al. 2022). Already, regions in the United States are seeing drastic increases in flooding since the 1950s - a study by the United States Environmental Protection Agency on 33 sites around the United States found flooding to be at least five times more common in over half the areas studies, with a strong concentration in sites along the eastern seaboard (EPA 2022). Given the rapid increase in flooding around the United States as well as the severe impacts this hazard can have, adaptation is becoming increasingly important and resources that already exist for these efforts are likely to become more strained.  

It will be increasingly important to understand the resources that are already available to communities, the accessibility of these resources, as well as how they are being used. This analysis seeks to uncover some of this through examining the trends in flood mitigation assistance provided by the Federal Emergency Management Agency. A time series analysis helped to identify possible trends in the number of grants received for flooding over time as well as the amount paid by FEMA to understand if trends in the use of these resources are similarly increasing as flooding has been. Furthermore, due to the drastic impacts of flooding that are only increasing, we were interested to examine if individuals are relying more heavily on ex-situ adaptation measures to move away from these hazards, or if communities are attempting to stay where they are despite the flooding and thus relying on in-situ adaptation measures. The research questions that guided this work were: 

1. Are there trends in the number of properties that received grants to adapt to flooding in the United States over time?
2. Are there trends in the amount FEMA paid for hazard mitigation for flooding over time?
3. How do these trends differ for in-situ vs ex-situ adaptation? 

The temporal scale of the research was defined by the FEMA Mitigated Properties dataset which included information on grants from 1985 until 2020 allowing the time series analysis to cover a 35 year time-frame. The grants included those received in all states in the United States. This analysis also included a brief spatial analysis focusing on one state in particular to spatially visualize the data as well as examine potential spatial trends in ex-situ vs. in-situ adaptation funding. 

\newpage

# Dataset Information

## 2.1 Dataset Background and Retrieval: 

We used data managed by the Federal Emergency Management Agency’s National Emergency Management Information Systems, downloaded directly in a CSV format through FEMA’s OpenFEMA resource. The dataset includes the record of properties that received grant assistance for hazard mitigation through any of the Hazard Mitigation Assistance grant programs, programs administered by FEMA that seek to reduce losses from disasters as well as protect life and property in the face of hazards (FEMA 2022). This includes: the Hazard Mitigation Grant Program, the Flood Mitigation Assistance Grant Program, and the Pre-Disaster Mitigation Grant Program (ibid.). Entries prior to 2012 also include grants received through the Repetitive Flood Claims Grant program and Severe Repetitive Loss Grant Program which both were eliminated through the Biggert Water Flood Insurance Reform Act of 2012 (ibid.). Each entry includes data such as the total amount paid, the number of properties receiving support, the hazard that the grant is adapting against, the program year, and others. The variables we used in particular were: Total Amount Paid per grant, Number of Properties per grant, Program Year, and the county where the grant was funded. These were wrangled and summed for our analysis. 

For the spatial analysis, the county boundaries for North Carolina were downloaded from the OpenESRI platform which had the State of North Carolina’s Emergency Management Agency’s best current available data as of 2020. These boundaries were identified through sources including the North Carolina Geodetic Survey, the North Carolina Department of Transportation, the United States Geological Survey, as well as field surveys that have been recorded by the respective county (State of North Carolina 2020). 

## 2.2 Data Wrangling

The mitigated properties dataset required three different types of wrangling for the analysis. First, we wrangled the data to result in a dataset with the total number of properties that received a grant for any type of flooding adaptation and the total amount paid for these per year. Second, we wrangled the data to have this same information, number of properties and total amount paid, for ex-situ adaptation, or buyouts, per year and did the same for in-situ adaptation. Finally, we wrangled the mitigated properties dataset in the same ways - finding number of properties and total amount paid for all flooding grants, ex-situ grants, and in-situ grants but instead of summarizing per year, we selected for only North Carolina grants and grouped the data by county for our spatial analysis. 


```{r typecodes, include=FALSE, message=FALSE, warning=FALSE}
insitutypecodes.list <- list(Code = c(202.1,202.2,202.3,202.4,203.1,203.2,203.3,203.4,204.1,204.2,204.3,204.4,204.5,204.6,207.2), Activity = c("Elevation of Private Structures—Riverine", "Elevation of Private Structures—Coastal", "Elevation of Public Structures—Riverine", "Elevation of Public Structures—Coastal", "Wet Floodproofing Private Structures—Riverine", "Wet Floodproofing Private Structures—Coastal", "Wet Floodproofing Public Structures—Riverine", "Wet Floodproofing Public Structures—Coastal", "Dry Floodproofing Private Structures—Riverine (Commercial)", "Dry Floodproofing Private Structures—Coastal (Commercial)","Dry Floodproofing Public Structures—Riverine", "Dry Floodproofing Public Structures—Coastal", "Dry Floodproofing Private Structures—Riverine (Residential-Historic)", "Dry Floodproofing Private Structures—Coastal (Residential-Historic)", "Mitigation Reconstruction"))

insitu_type.df <- as.data.frame(do.call(cbind, insitutypecodes.list ))

exsitutypecodes.list <- list(Code = c(200.1,200.2,200.3,200.4,200.5,201.1,201.2,201.3,201.4), Activity = c("Acquisition of Private Real Property (Structures and Land)—Riverine", "Acquisition of Private Real Property (Structures and Land)—Coastal", "Acquisition of Public Real Property (Structures and Land)—Riverine", "Acquisition of Public Real Property (Structures and Land)—Coastal", "Acquisition of Vacant Land", "Relocation of Private Structures—Riverine", "Relocation of Private Structures—Coastal", "Relocation of Public Structures—Riverine",
"Relocation of Public Structures—Coastal"))

exsitu_type.df <- as.data.frame(do.call(cbind, exsitutypecodes.list))

typecodes <- rbind(insitu_type.df, exsitu_type.df)
```
\newpage
                    *Table 1: Selected Flooding Adaptation Type Codes*                
```{r message = FALSE, warning = FALSE, echo = FALSE}
gtobject <- gt(data = typecodes, caption  = "Table 1: Selected Flooding Adaptation Type Codes")
gt.typecodes <- gtobject %>%

  tab_header(
    title="Mitigated Properties Flooding Type Codes",
  ) %>% 
  
  tab_options(
    row_group.font.weight = "bold",
    row_group.border.bottom.width = 1, 
    table_body.vlines.style = "dashed", 
    table_body.vlines.width = 0.5, 
    table_body.vlines.color = "grey"
  )%>%

  tab_source_note(
    source_note = "Source: Open FEMA Dataset"
  )%>%
  
    tab_row_group(
    label = "Ex-Situ Adaptation",
    rows = c(16:24)
  )%>%
  
    tab_row_group(
    label = "In-Situ Adaptation",
    rows = c(1:15)
  )

  
gt.typecodes

```

In order to do so, we first examined and explored the dataset and found that some entries had a total amount paid that was negative. Because the OpenFEMA information page included a note that these were manually entered data and subject to human error, we made the assumption that this was due to human error and removed these negative values from our analysis. After doing so, we used this cleaned mitigated properties dataset to create our three different types of wrangled datasets. This involved, first, examining the “type” codes to identify which type codes indicate that the grants were used for flooding. Table 1 shows the type codes that were used, grouped by ex-situ and in-situ codes. These type codes together were used to find all flooding grants regardless of adaptation type. 

After selecting out the relevant flooding type codes, we grouped by year or county and summarized the datasets to find the sum of the number of properties and the total amount paid for each category we were examining in this analysis (amount paid for all flooding grants per year, amount paid for ex-situ grants per year, etc.).For the total amount paid categories specifically, using the “priceR” package, we adjusted each of the total amount paid values per year for all adaptation, ex-situ, and in-situ for inflation. Summary statistics for the respective wrangled datasets can be found in table 2. 


```{r message=FALSE, warning=FALSE, include=FALSE}

summary.floodpropsall <- databyyear%>%  
  summarize(
    length=length(Floodpropertiesperyear),
    mean=mean(Floodpropertiesperyear),
    median=median(Floodpropertiesperyear),
    sd=sd(Floodpropertiesperyear))%>%
  mutate("Name" = "Total Number of Properties")

summary_allfloods2 <- summary.floodpropsall[, c(5, 1, 2, 3, 4)]
summary_allfloods2

summary.paidperyear <- databyyear%>%
  summarize(
    length=length(Floodproperties_amountpaid),
    mean=mean(Floodproperties_amountpaid),
    median=median(Floodproperties_amountpaid),
    sd=sd(Floodproperties_amountpaid)) %>%
  mutate("Name" = "Total Amount Paid ($)")

summary_paidperyear2 <- summary.paidperyear[, c(5, 1, 2, 3, 4)]

summary.insitu.properties <- databyyear%>%
  summarize(
    length=length(insitupropertiesperyear),
    mean=mean(insitupropertiesperyear),
    median=median(insitupropertiesperyear),
    sd=sd(insitupropertiesperyear))%>%
  mutate("Name" = "In-Situ Number of Properties")

summary_insituprops2 <- summary.insitu.properties[, c(5, 1, 2, 3, 4)]

summary.insitu.amntpaid <- databyyear%>%  
  summarize(
    length=length(insituproperties_amountpaid),
    mean=mean(insituproperties_amountpaid),
    median=median(insituproperties_amountpaid),
    sd=sd(insituproperties_amountpaid))%>%
  mutate("Name" = "In-Situ Amount Paid ($)")

summary_insitupaid2 <- summary.insitu.amntpaid[, c(5, 1, 2, 3, 4)]

summary.exsitu.properties <- databyyear%>%
  summarize(
    length=length(Buyouts_propertiesperyear),
    mean=mean(Buyouts_propertiesperyear),
    median=median(Buyouts_propertiesperyear),
    sd=sd(Buyouts_propertiesperyear))%>%
  mutate("Name" = "Ex-Situ Number of Properties")

summary_exsituprops2 <- summary.exsitu.properties[, c(5, 1, 2, 3, 4)]

summary.exsitu.amntpaid <- databyyear%>%
  summarize(
    length=length(Buyouts_propertiesamountpaid),
    mean=mean(Buyouts_propertiesamountpaid),
    median=median(Buyouts_propertiesamountpaid),
    sd=sd(Buyouts_propertiesamountpaid))%>%
  mutate("Name" = "Ex-Situ Amount Paid ($)")

summary_exsitupaid2 <- summary.exsitu.amntpaid[, c(5, 1, 2, 3, 4)]


Allsummarystatistics <- rbind(summary_allfloods2, summary_paidperyear2, summary_insituprops2, summary_insitupaid2, summary_exsituprops2, summary_exsitupaid2)
```



*Table 2: FEMA Hazard Mitigated Properties Dataset: Summary Statistics*                  
```{r message=FALSE, warning=FALSE, echo=FALSE}

gt.summstats <- Allsummarystatistics %>%
  rename("Category" = Name, "Observations" = length, "Mean" = mean, "Median" = median, "SD" = sd) %>%   
  gt %>% 
  fmt_number(columns = c(Observations), decimals = 0) %>%
  fmt_number(columns = c(Mean), decimals=2) %>%
  fmt_number(columns = c(SD), decimals = 0) %>%
  fmt_number(columns = c(Median), decimals = 2) %>% 
  
  cols_align(
      align = "center",
      columns = Observations
    )%>%
  
  tab_header(
    title=md("**Administration of Hazard Mitigation Grants**"),
  ) %>% 
  
  tab_options(
    row_group.font.weight = "bold",
    row_group.border.bottom.width = 1, 
    table_body.vlines.style = "dashed", 
    table_body.vlines.width = 0.5, 
    table_body.vlines.color = "grey"
  )%>%

  tab_source_note(
    source_note = "Source: Open FEMA Dataset"
  )%>%
  
    tab_row_group(
    label = md("***Ex-Situ Adaptation***"),
    rows = c(5:6)
  )%>%
  
    tab_row_group(
    label = md("***In-Situ Adaptation***"),
    rows = c(3:4)
  )%>%
  
  tab_row_group(
    label = md("***All Adaptation***"),
    rows = c(1:2)
  )
  
gt.summstats

```


\newpage

# Exploratory Analysis 

After wrangling the data, we explored the data both over time as well as totals for the number of properties and amount paid in our dataset, compared between all flooding and ex-situ vs. in-situ. Figure 1 shows the differences in the total number of properties between 1985 and 2020 that received adaptation flooding, comparing all of the properties with ex-situ and in-situ. The graph shows that more properties received ex-situ than in-situ grants by a considerable amount. 


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Total Properties that Received Flood Adaptation Funding from 1985 to 2020"}
ggplot(data = totalprops_pivot, aes(x = Category, y = Total)) +
  geom_bar(stat = "identity", fill = "cornflowerblue")+
  labs( 
    title = "Total Properties that Received Flooding Adaptation Funding from 1985 - 2020", 
    x = "Adaptation Type", 
    y = "Number of Properties")
```


To examine this relationship further, we compared the total amount paid for all adaptation types and in-situ vs. ex-situ in Figure 2. In including both the total amount paid as reported by FEMA as well as these values adjusted to 2020 dollars, this figure helps to also show the difference that inflation makes in the resulting total amount paid. 
\newline

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Total Amount Paid for Flooding Adaptation from 1985 - 2020"}
ggplot(data = totals_inflation_pivot, aes(x = Category, y = Total)) +
  geom_bar(stat = "identity", fill = "steelblue3")+
  labs( 
    title = "Total Amount Paid for Flooding Adaptation from 1985 - 2020", 
    subtitle = "Amount Paid With and Without Inflation Adjustments to 2020 USD",
    x = "Adaptation Type", 
    y = "Amount Paid (USD)")
```

Finally, figures 3 and 4 show this same data over time. Figure 3 shows the number of properties that received flood adaptation grants per year between 1985 and 2020. 
\newline

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Number of Properties that Received Flood Adaptation Grants from 1985 - 2020"}
ggplot(data = databyyear, aes(x = programFy, y = Floodpropertiesperyear)) +
  geom_bar(stat = "identity", fill = "cornflowerblue")+
  labs( 
    title = "Number of Properties that Received Flood Adaptation Grants from 1985 - 2020", 
    x = "Year", 
    y = "Number of Properties")
```

Figure 4 shows the total amount paid by FEMA through flood adaptation grants per year between 1985 and 2020.
\newline

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Total Amount Paid for Flood Adaptation Grants from 1985 to 2020 in 2020 inflation adjusted U.S. dollars"}
ggplot(data = inflation_data, aes(x = programFy, y = InflationAdjusted_AllAmountpaid)) +
  geom_bar(stat = "identity", fill = "steelblue3")+
  labs( 
    title = "Total Amount Paid for Flood Adaptation Grants 1985 - 2020", 
    x = "Year", 
    y = "Total Amount Paid (2020 USD)")
```

These graphs, as well as the graphs of ex-situ and in-situ data over time, are further examined in the analysis section including trend-lines to complement the time series analysis. 

\newpage

# Analysis

This analysis involved nine time series analysis which all sought to examine monotonic trends over time in the number of properties receiving grant funding for flooding adaptation and the total amount paid for flooding adaptation from these grants. These nine analysis can be understood based on the questions that each time series helps to answer: 

***All Adaptation***  

* Total Number of Properties: Is there a monotonic trend in the total number of properties that receive grant funding over time?

* Total Amount Paid for All Adaptation: Is there a monotonic trend in the total amount paid for flooding adaptation grants over time?

* Total Amount Paid - Inflation Adjusted: Is there (still) a monotonic trend in the total amount paid for flooding adaptation grants over time when adjusting for inflation to 2020 dollars?

***Ex-Situ Adaptation***  

* Number of Buyouts: Is there a monotonic trend in the total number of properties that received ex-situ grant funding, or funding to buyout the property, over time?

* Amount Paid for Buyouts: Is there a monotonic trend in the amount paid for buyouts over time?

* Amount Paid for Buyouts - Inflation Adjusted: Is there (still) a monotonic trend in the amount paid for buyouts after adjusting for inflation to 2020 dollars?  


***In-Situ Adaptation***  

* Number of In-Situ Properties: Is there a monotonic trend in the total number of properties that received in-situ grant funding to adapt in place over time?

* Amount Paid for In-Situ Adaptation: Is there a monotonic trend in the amount paid for in-situ adaptation over time?

* Amount Paid for In-Situ Adaptation - Inflation Adjusted: Is there (still) a monotonic trend in the amount paid for in-situ adaptation after adjusting for inflation to 2020 dollars?

These data were also visualized through a spatial analysis of the number of properties and total amount paid for flood adaptation grants in North Carolina including for all grants, ex-situ grants, and in-situ grants. 

## 4.1 All Adaptation Types 

Beginning with the analysis of all adaptation types, overall the only statistically significant monotonic trend found was the trend in the total amount paid for flood adaptation in the United States, before adjusting for inflation. The total number of properties that received adaptation funding from 1985 to 2020 did not have a statistically significant monotonic trend (p > 0.9) which is evident in figure 5 which shows the number of properties over time as well as the associated trend line. 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Number of Properties that Received Flood Adaptation Grants between 1985 and 2020"}
ggplot(databyyear, aes(y= Floodpropertiesperyear, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= Floodpropertiesperyear, x = programFy), color = "cornflowerblue", show.legend = FALSE)+
  labs(title = "Number of Properties that Received Flood Adaptation Grants from 1985 - 2020", 
       x = "Fiscal Year", 
       y= "Number of Properties per Year")
```

The second time series analysis which was statistically significant (p = 0.004), showed an increasing trend (tau = 0.361) in the total amount paid over time for flood adaptation through FEMA. Figure 6 shows this data over time with the associated trend line. 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Total Amount Paid for Flood Adaptation between 1985 and 2020"}
ggplot(databyyear, aes(y= Floodproperties_amountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= Floodproperties_amountpaid, x = programFy), color = "steelblue3", show.legend = FALSE)+
  labs(title = "Total Amount Paid for Flood Adaptation in the United States: 1985 - 2020",
       x = "Year", 
       y= "Total Amount Paid for Flood Adaptation (USD)")
```

However, after adjusting the total amount paid for each year for inflation and thus making each value in 2020 dollars this trend was no longer statistically significant (p = 0.568). This can be seen in figure 7 which shows the inflation adjusted values for total amount paid over time. 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Total Amount Paid for Flood Adaptation between 1985 and 2020: 2020 Inflation Adjusted U.S. Dollars"}
ggplot(inflation_data, aes(y= InflationAdjusted_AllAmountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= InflationAdjusted_AllAmountpaid, x = programFy), color = "steelblue3", show.legend = FALSE)+
  labs(title = "Inflation Adjusted Total Amount Paid for Flood Adaptation in the United States: 1985 - 2020", 
       x = "Year", 
       y= "2020 US Dollars")
```

A summary of each of these time series results can be found in table 3. 

```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ts_propall_wrangle <- ts_propall%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Number of Properties")
ts_paidall_wrangle <- ts_paidall%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Total Amount Paid")

ts_inflationpaidall_wrangle <- ts_paidinflationall%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Inflation Adjusted Total Amount Paid")
alladapt.results <- rbind(ts_propall_wrangle, ts_inflationpaidall_wrangle, ts_inflationpaidall_wrangle)

```

*Table 3: Results from Time Series Analysis of All Adaptation Types*                    
```{r echo=FALSE, message=FALSE, warning=FALSE}
gt.alladaptresults <- alladapt.results  %>%
  gt %>% 
  fmt_number(columns = c(Result), decimals = 3) %>%

  tab_header(
    title=md("***Time Series Analysis Results: All Adaptation Types***"),
  ) %>% 
  
  cols_hide(columns = c(
      Analysis))%>%
      
  tab_options(
    row_group.font.weight = "bold",
    row_group.border.bottom.width = 1, 
    table_body.vlines.style = "dashed", 
    table_body.vlines.width = 0.5, 
    table_body.vlines.color = "grey"
  )%>%

    tab_row_group(
    label = md("**Inflation Adjusted Total Amount Paid**"),
    rows = c(5:6)
  )%>%
  
    tab_row_group(
    label = "**Total Amount Paid**",
    rows = c(3:4)
  )%>%
  
  tab_row_group(
    label = "**Number of Properties**",
    rows = c(1:2)
  )

  
gt.alladaptresults
```

These findings suggest that there is no statistically significant monotonic trend in the number of properties that receive grants for flooding adaptation nor the amount spent on flooding adaptation by the Federal Emergency Management Agency. Though there was a trend in the total amount paid, this trend was no longer present when adjusting for inflation suggesting that the trend was likely a reflection of inflation rather than of an increase in amount spent. 



## 4.2 Ex-Situ Adaptation 

The second analysis involved the three time series analyses identifying possible monotonic trends in ex-situ adaptation between 1985 and 2020. Again, the only statistically significant monotonic trend was the trend in total amount paid for buyouts before adjusting for inflation. There does appear to be a declining trend in the total number of properties that received ex-situ funding from FEMA as seen in Figure 8, however, the time series analysis reveals that this is not a statistically significant trend (p = 0.57). 


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Number of Properties that Received Funding for Ex-Situ Adaptation to Flooding between 1985 and 2020"}
ggplot(databyyear, aes(y= Buyouts_propertiesperyear, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= Buyouts_propertiesperyear, x = programFy), color = "cornflowerblue", show.legend = FALSE)+
  labs(title = "Number of Properties that Received Funding for Ex-Situ Adaptation to Flooding", 
  subtitle = "1985 - 2020", 
  y = "Number of Properties", 
  x = "Year")
```

The statistically significant monotonic trend in the total amount paid for buyouts (p = 0.003) can be found in figure 9. 


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Total Amount Paid for Ex-Situ Adaptation to Flooding between 1985 and 2020"}
ggplot(databyyear, aes(y= Buyouts_propertiesamountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= Buyouts_propertiesamountpaid, x = programFy), color = "steelblue3", show.legend = FALSE)+
  labs(title = "Total Amount Paid for Ex-Situ Flood Adaptation in the United States",
  subtitle = "1985 - 2020", 
  y = "Amount Paid (USD)", 
  x = "Year") 
```


However, after adjusting for inflation, again, the trend in total amount paid was no longer found to be statistically significant with a p-value of 0.503 after adjusting each total amount paid value to 2020 dollars. Figure 10 shows the graph of this trendline and data over time. 

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Total Amount Paid for Ex-Situ Adaptation to Flooding between 1985 and 2020 in 2020 Inflation Adjusted U.S. Dollars."}
ggplot(inflation_data, aes(y= InflationAdjusted_BUYOUTAmountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= InflationAdjusted_BUYOUTAmountpaid, x = programFy), color = "steelblue3", show.legend = FALSE)+
  labs(title = "Inflation Adjusted Total Amount Paid for Buyouts in the United States",
  subtitle = "1985 - 2020", 
       x = "Year", 
       y= "2020 US Dollars") 
```

A table of the results of all of these three analyses can be found in table 4. 

```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ts_propbuyout_wrangle <- ts_buyoutprops%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Number of Properties")
ts_paidbuyout_wrangle <- ts_buyoutpaid%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Total Amount Paid")

ts_inflationpaidBUYOUT_wrangle <- ts_buyoutpaidinflation%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Inflation Adjusted Total Amount Paid")
buyouts.tsresults <- rbind(ts_propbuyout_wrangle , ts_paidbuyout_wrangle, ts_inflationpaidBUYOUT_wrangle)

```
\newpage
*Table 4: Results from Time Series Analysis of Ex-Situ Adaptation*              
```{r echo=FALSE, message=FALSE, warning=FALSE}
gt.alladaptresults <- buyouts.tsresults  %>%
  gt %>% 
  fmt_number(columns = c(Result), decimals = 3) %>%

  tab_header(
    title=md("***Time Series Analysis Results: Ex-Situ Adaptation***"),
  ) %>% 
  
  cols_hide(columns = c(
      Analysis))%>%
      
  tab_options(
    row_group.font.weight = "bold",
    row_group.border.bottom.width = 1, 
    table_body.vlines.style = "dashed", 
    table_body.vlines.width = 0.5, 
    table_body.vlines.color = "grey"
  )%>%

    tab_row_group(
    label = md("**Inflation Adjusted Total Amount Paid**"),
    rows = c(5:6)
  )%>%
  
    tab_row_group(
    label = md("**Total Amount Paid**"),
    rows = c(3:4)
  )%>%
  
  tab_row_group(
    label = md("**Number of Properties**"),
    rows = c(1:2)
  )

  
gt.alladaptresults
```

These findings are consistent with the overall trends in all flooding adaptation grants over time, suggesting that there is not a statistically significant increase in ex-situ adaptation over time. Again, the trend in the total amount spent was likely due to trends in inflation rather than the actual amount spent as the trend was no longer present when accounting for inflation in the final time series analysis.  



## 4.3 In-Situ Analysis 

The final time series analysis examined in-situ adaptation specifically, which is adaptation in place that allows an individual to adapt their property to the flooding through putting in a seawall, raising their home, etc. Again these time series examined possible monotonic trends in the number of properties and the total amount paid with and without inflation adjustments between 1985 and 2020. There was again only one statistically significant trend, however, for this analysis it was the trend in the number of properties over time. 

The number of properties that received in-situ adaptation funding was found to have a statistically significant monotonic increasing trend (p = 0.0004, tau = 0.44). This trend can be seen in figure 11. 

```{r echo = FALSE, message=FALSE, warning=FALSE, fig.cap = "Number of Properties that Received Grant Funding for In-Situ Adaptation to Flooding between 1985 and 2020."}
ggplot(databyyear, aes(y= insitupropertiesperyear, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= insitupropertiesperyear, x = programFy), color = "cornflowerblue", show.legend = FALSE)+
  labs(title = "Number of Properties that Received Funding for In-Situ Adaptation to Flooding", 
  subtitle = "1985 - 2020", 
  x = "Year", 
  y = "Number of Properties")
```

The other two analyses, total amount paid and inflation adjusted total amount paid, were not statistically significant with p-values of 0.207 and 0.484 respectively. The graphs showing this data over time with the associated trend line can be seen in figures 12 and 13. Both graphs show a drastic spike in payments in 2008 - this is likely due to Hurricane Katrina where significant funding was needed to help communities in Louisiana recover and adapt to these types of storms. 

```{r message=FALSE, warning=FALSE, echo=FALSE, fig.cap = "Total Amount Paid for In-Situ Adaptation to Flooding between 1985 and 2020."}
ggplot(databyyear, aes(y= insituproperties_amountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= insituproperties_amountpaid, x = programFy), color = "steelblue4", show.legend = FALSE)+
  labs(title = "Total Amount Paid for In-Situ Flood Adaptation in the United States",
  subtitle = "1985 - 2020", 
  y = "Amount Paid (USD)", 
  x = "Year")
```


```{r warning = FALSE, echo = FALSE, message = FALSE,  fig.cap = "Total Amount Paid for In-Situ Adaptation to Flooding between 1985 and 2020 in 2020 Inflation Adjusted U.S. Dollars."}
ggplot(inflation_data, aes(y= InflationAdjusted_INSITUAmountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= InflationAdjusted_INSITUAmountpaid, x = programFy), color = "steelblue4", show.legend = FALSE)+
  labs(title = "Inflation Adjusted Total Amount Paid for In Situ Adaptation in the United States",
  subtitle = "1985 - 2020", 
       x = "Year", 
       y= "2020 US Dollars")
```


A table of each of these time series results can be found in table 5. 


```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ts_propINSITU_wrangle <- ts_insituprops%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Number of Properties")

ts_paidINSITU_wrangle <- ts_insitupaid %>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Total Amount Paid")

ts_inflationpaidINSITU_wrangle <- ts_insitupaidinflation%>%
  select(Measure,Result)%>%
  mutate('Analysis' = "Inflation Adjusted Total Amount Paid")

insitu.tsresults <- rbind(ts_propINSITU_wrangle , ts_paidINSITU_wrangle, ts_inflationpaidINSITU_wrangle)

```



*Table 5: Results from Time Series Analysis of In-Situ Adaptation*            
```{r echo=FALSE, message=FALSE, warning=FALSE}
gt.insituresults <- insitu.tsresults  %>%
  gt %>% 
  fmt_number(columns = c(Result), decimals = 3) %>%

  tab_header(
    title=md("***Time Series Analysis Results: In-Situ Adaptation***"),
  ) %>% 
  
  cols_hide(columns = c(
      Analysis))%>%
      
  tab_options(
    row_group.font.weight = "bold",
    row_group.border.bottom.width = 1, 
    table_body.vlines.style = "dashed", 
    table_body.vlines.width = 0.5, 
    table_body.vlines.color = "grey"
  )%>%

    tab_row_group(
    label = md("**Inflation Adjusted Total Amount Paid**"),
    rows = c(5:6)
  )%>%
  
    tab_row_group(
    label = md("**Total Amount Paid**"),
    rows = c(3:4)
  )%>%
  
  tab_row_group(
    label = md("**Number of Properties**"),
    rows = c(1:2)
  )

  
gt.insituresults
```


Overall, these findings suggest that more properties are receiving in-situ adaptation funding, yet the total amount paid for in-situ adaptation is not changing significantly. The increase in number of properties is what one would expect given the increasing number of people that are exposed to flooding over time. The lack of a paralleling trend in total amount paid requires deeper analysis. It could be because the measures are becoming more affordable as they are becoming more common and necessary, or because more individuals are seeking more minor in-situ adaptation projects. Deeper analysis on the exact type of adaptation action would be necessary to understand why these trends exist. Still, this analysis provides important insight that indicates that there is a statistically significant increase in the number of properties that are adapting in place to flooding impacts. 

## 4.4 Spatial Analysis 

The final part of this analysis sought to spatially visualize this data as to explore possible spatial trends in the data to complement that analysis of temporal trends. This spatial analysis specifically looked at the data for North Carolina due to data availability and size. These maps show the number of properties all adaptation, in-situ, and ex-situ at the county level. The spatial analysis specifically showed the number of properties rather than also or instead including the total amount paid because the resulting maps were the same for both as the spatial trends were consistent. Number of properties did not require inflation adjustments and thus was selected over total amount paid for the analysis. 

First, Figure 14 helps to visualize where in North Carolina these adaptation grants are concentrated by mapping the number of properties that received flooding adaptation grants by county.

```{r include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
flood_counties_join <- left_join(NC_countyboundaries, NC_flooddata, by = "County")

#Turn NAs to zeros again for added counties from map 
flood_counties_join [is.na(flood_counties_join)] <- 0 

class(flood_counties_join)
```

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Spatial Distribution of the Number of Properties that Received Flooding Adaptation Grant Funding between 1985 - 2020"}
ggplot(data=flood_counties_join) +
  geom_sf(aes(fill=All_properties)) + 
  scale_fill_gradientn(colours = colorspace::heat_hcl(7), trans = 'reverse', name = "Number of Properties")+
  labs(
    title='Number of Properties that Received Flooding Adaptation Funding: 1985-2020',
    fill ='Number of Properties'
  )+
  theme(plot.title = element_text(size=10), 
        legend.text = element_text(size = 9), 
        legend.title = element_text(size = 9))
```

Figure 15 and 16 help to compare the areas that have a high number of properties that received flooding adaptation grants for ex-situ vs. in-situ grants. 

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Spatial Distribution of the Number of Properties that Received In-Situ Flooding Adaptation Grant Funding between 1985 - 2020"}
ggplot(data=flood_counties_join) +
  geom_sf(aes(fill=insitupropertiesperyear)) + 
  scale_fill_gradientn(colours = colorspace::heat_hcl(7), trans = 'reverse', name = "Number of Properties")+
  labs(
    title='Number of Properties that Received In Situ Adaptation Funding: 1985-2020',
    fill ='Number of Properties'
  )+
  theme(plot.title = element_text(size=10), 
        legend.text = element_text(size = 9), 
        legend.title = element_text(size = 9))
```

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Spatial Distribution of the Number of Properties that Received Ex-Situ Flooding Adaptation Grant Funding between 1985 - 2020"}
ggplot(data=flood_counties_join) +
  geom_sf(aes(fill=Buyouts_propertiesperyear)) + 
  scale_fill_gradientn(colours = colorspace::heat_hcl(7), trans = 'reverse', name = "Number of Properties")+
  labs(
    title='Number of Properties that Received Ex Situ Adaptation Funding: 1985-2020',
    fill ='Number of Properties'
  )+
  theme(plot.title = element_text(size=10), 
        legend.text = element_text(size = 9), 
        legend.title = element_text(size = 9))
```

In comparing these two maps it is very clear that the ex-situ adaptation funding is concentrated in the inland county whereas the in-situ adaptation funding is concentrated on the coast. This is an important finding, suggesting that buyouts occur more often inland likely from riverine flooding whereas in-situ adaptation may be more common for coastal flooding. 


\newpage

# Summary and Conclusions

## 5.1 Lack of Overall Trends in Flooding Adaptation 

For almost all of the time series analyses, we found no statistically significant trend. This was true for trends in all adaptation types for number of properties and total amount paid (after inflation adjustments), as well as for buyouts for number of properties and total amount paid (after inflation adjustments). There was also no statistically significant trend in the total amount paid for in-situ adaptation. This is inconsistent with the initial hypothesis that all of these would be increasing due to the increase in flooding hazards across the United States. However, a lack of a trend is still an important finding in that it suggests that further analysis is needed to understand why these resources are not being used. This could indicate that despite potential increases in flooding, communities are not experiencing this to the level that an adaptation measure would be necessary. Alternatively, this could indicate that communities may just not be aware of the resources that are available to them in the face of flooding hazards. The lack of trends in buyouts may be a result of a number of factors given the complicated nature of buyouts socially and economically. Communities may be less apt to seek out a buyout because of the challenges of moving, going through the bureaucratic process, forming a new community, finding a new home, tc. and it may not be a reflection of their exposure to hazard. 

## 5.2 Trends in In-Situ Flooding Adaptation: Spatial and Temporal

The only statistically significant trends, after adjusting the total amount paid values for inflation, was the number of properties receiving in-situ adaptation funding. In this case, again, the driver of this trend is unknown. However, in considering this, the spatial analysis can complement the interpretation of these findings. The spatial analysis showed that the number of properties in North Carolina receiving in-situ adaptation grants was heavily concentrated near the coast, while the ex-situ adaptation properties were much more present inland from the coast. 

While there are many drivers of flooding and changes in flooding, climate change has made the sea levels rise increasing coastal flooding dramatically. If ex-situ adaptation primarily serves riverine flooding, these grants would not be impacted by sea level rise trends. Similarly, if in-situ funding primarily serves coastal communities one would expect an increasing trend in in-situ grants associated with the increase in sea level. This is reflected in our findings for both in-situ and ex-situ trends in the number of properties over time, with the spatial analyis providing insight on how to consider these findings. It is possible that the increase in in-situ adaptation is associated with the increase in sea level whereas the ex-situ adaptation funding is more responsive to changes in inland flooding. However, this is just a hypothesis based on the findings from this analysis. A nationwide analysis of the spatial trends in in-situ vs. ex-situ adaptation is necessary to determine if this is consistent across the United States and then a deeper analysis is necessary to identify drivers of these trends such as sea level rise. 

## 5.3 Opportunities for Future Research

The findings from this analysis provided foundations for future research on trends in adaptation funding in the United States. Extending the spatial analysis to include the entirety of the United States would allow an exploration of the trends in ex-situ and in-situ grants beyond those in North Carolina to identify if these are representative of the rest of the United States. Furthermore, deeper analysis that compare these trends with those of sea level rise, as well as socio-economic factors such as the cost of adaptation, would allow researchers to begin to identify potential drivers of these trends. 

\newpage

# References
State of North Carolina. 2020. "North Carolina State and County Boundary Polygons." *ArcGIS Hub.* https://hub.arcgis.com/datasets/NCEM-GIS::north-carolina-state-and-county-boundary-polygons/about

Environmental Protection Agency. 2020. "Climate Change Indicators: Coastal Flooding." *Climate Change Indicators.* https://www.epa.gov/climate-indicators/climate-change-indicators-coastal-flooding#:~:text=Data%20%7C%20Technical%20Documentation-,Key%20Points,Coasts%20(see%20Figure%202).

Internal Displacement Monitoring Centre (IDMC). 2019. "United States of America: Figure Analysis, Displacement Related to Disasters." *IDMC.* https://www.internal-displacement.org/sites/default/files/inline-files/GRID-2019-Disasters-Figure-Analysis-UnitedStates.pdf 

Lindsey, R. 2022. "Climate Change: Global Sea Level." *Climate.gov.* https://www.climate.gov/news-features/understanding-climate/climate-change-global-sea-level 

Federal Emergency Management Agency (FEMA). 2022. "OpeFEMA Dataset: Hazard Mitigation Assistance Mitigated Properties - v2." *Reports & Data.* https://www.fema.gov/openfema-data-page/hazard-mitigation-assistance-mitigated-properties-v2

Wing O., Lehman, W., Bates, P., Sampson, C., Quinn, N., Smith, A., Neal, J., Porter, J., & Kousky, C. 2022. "Inequitable patterns of US flood risk in the Anthropocene." *Nature* 12:
https://www.nature.com/articles/s41558-021-01265-6
