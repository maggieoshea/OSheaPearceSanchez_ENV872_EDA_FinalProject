---
title: "Wrangling data"
author: "Maggie O'Shea"
date: "4/2/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)

hazard_properties <- read.csv("./Data /Raw Data /HazardMitigationAssistanceMitigatedProperties.csv")
```

#Note: 
I wrangled the data in two ways. First, like we talked about, I summarized amount paid over time, then looked at the amount paid for in-situ vs. ex-situ adaptation. However, all the observations before 1999 are NAs for amount paid and there are a few negative numbers (which I removed). Because of all this, I also summarized by number of properties in case we wanted to also look at that because we had data further back in time. 


#Actual Amount Paid 
```{r}
#All flood properties
colnames(hazard_properties)
clean_hazardprops <- hazard_properties %>%
  filter(!is.na(actualAmountPaid))%>%
  filter(actualAmountPaid > 0)

floodproperties_amountpaid <- clean_hazardprops %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10|202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(programFy)%>%
  summarise(Floodproperties_amountpaid = sum(actualAmountPaid))

#Ex situ
buyoutfloodproperties_amountpaid <- clean_hazardprops %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10', type))%>%
  group_by(programFy)%>%
  summarise(Buyouts_propertiesamountpaid = sum(actualAmountPaid))

#In situ
insitufloodproperties_amountpaid <- clean_hazardprops %>%
  filter(grepl('202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(programFy)%>%
  summarise(insituproperties_amountpaid = sum(actualAmountPaid))
```

```{r}
ggplot(floodproperties_amountpaid, aes(y= floodproperties_amountpaid , x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= floodproperties_amountpaid, x = programFy), color = "coral", show.legend = FALSE)+
  labs(title = "All Flood Properties Amount Paid over Time"
       x= Fiscal Year
       y= Buy )

ggplot(buyoutfloodproperties_amountpaid, aes(y= Buyouts_propertiesamountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= Buyouts_propertiesamountpaid, x = programFy), color = "coral", show.legend = FALSE)+
  labs(title = "Ex-Situ Flood Properties Amount Paid over Time")

ggplot(insitufloodproperties_amountpaid, aes(y= insituproperties_amountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= insituproperties_amountpaid, x = programFy), color = "coral", show.legend = FALSE)+
  labs(title = "In-Situ Flood Properties Amount Paid over Time")
```


Based on the graph and data for in-situ adaptation, 2008 looks like a bit of an outlier with a larger amount paid than the rest of the years, so I wanted to see what it looked like without 2008: 
```{r}

no2008_insitufloodproperties <- insitufloodproperties_amountpaid%>%
  filter(programFy != 2008) 

ggplot(no2008_insitufloodproperties, aes(y= insituproperties_amountpaid, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= insituproperties_amountpaid, x = programFy), color = "coral", show.legend = FALSE)+
  labs(title = "In-Situ Flood Properties Amount Paid over Time")

```

#Number of Properties 
```{r}
#All flood properties
floodproperties <- hazard_properties %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10|202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(programFy)%>%
  summarise(Floodpropertiesperyear = sum(numberOfProperties))


#Ex situ
buyoutfloodproperties <- hazard_properties %>%
  filter(grepl('200.1|200.2|200.3|200.4|200.5|200.6|200.7|200.8|200.9|201.1|201.2|201.3|201.4|201.5|201.6|201.7|201.8|201.9|201.10', type))%>%
  group_by(programFy)%>%
  summarise(Buyouts_propertiesperyear = sum(numberOfProperties))

#In situ
insitufloodproperties <- hazard_properties  %>%
  filter(grepl('202.1|202.2|202.3|202.4|203.1|203.2|203.3|203.4|204.1|204.1|204.2|204.3|204.4|204.5|204.6|207.2', type))%>%
  group_by(programFy)%>%
  summarise(insitupropertiesperyear = sum(numberOfProperties))


ggplot(floodproperties, aes(y= Floodpropertiesperyear, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= Floodpropertiesperyear, x = programFy), color = "coral", show.legend = FALSE)+
  labs(title = "All Flood Properties over Time")

ggplot(buyoutfloodproperties, aes(y= Buyouts_propertiesperyear, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= Buyouts_propertiesperyear, x = programFy), color = "coral", show.legend = FALSE)+
  labs(title = "Ex-Situ Flood Properties over Time")

ggplot(insitufloodproperties, aes(y= insitupropertiesperyear, x = programFy)) + 
  geom_line() +
  geom_smooth(method = lm, aes(y= insitupropertiesperyear, x = programFy), color = "coral", show.legend = FALSE)+
  labs(title = "In-Situ Flood Properties over Time")

```


#I combined the data in a variety of different ways depending on what would be the most useful for the analysis. There is one for each of the three categories (all flood properties, just ex-situ, just in-situ) with both the properties and total amount paid. There is also a dataframe with all of this information in one including the number of properties and amount paid for all flood properties, for in-situ, and for ex-situ. 
```{r}
propertiesvalue_allflood <- left_join(floodproperties, floodproperties_amountpaid, by = "programFy")

insitu_paidprops<- left_join(insitufloodproperties, insitufloodproperties_amountpaid, by = "programFy")

exsitu_paidprops <- left_join (buyoutfloodproperties, buyoutfloodproperties_amountpaid, by = "programFy") 

joinexsitu_insitu <- left_join (exsitu_paidprops, insitu_paidprops, by = "programFy")

all_data_propvalue <- left_join(propertiesvalue_allflood, joinexsitu_insitu, by = "programFy")
```

#Make NAs Zero, and Date column which is January 1st for each year.  *Note this as an assumption we made in the discussion*
```{r}
zero_NA_alldata <- all_data_propvalue%>%
  mutate("Date" = paste("1/1/", programFy))

zero_NA_alldata$Date <- gsub(" ", "", zero_NA_alldata$Date)

zero_NA_alldata$Date <- as.Date(zero_NA_alldata$Date, "%m/%d/%Y")


zero_NA_alldata[is.na(zero_NA_alldata)] <- 0

```




